# DEC-JAN-26: Simplified Activation Protocol

**DOC-PROC-010** | Streamlined Mode Activation with Beads Integration

---

**Status:** Active
**Date:** 2026-01-26
**Updated:** 2026-01-26 (v2.4.0 - Agent Consolidation)
**Authors:** Human + Claude collaboration
**Supersedes:** DEC-009 (activation-context.yaml - deprecated)
**Related:** DEC-007 (two-tier learning)
**Beads:** Ways of Development-157, Ways of Development-173
**Version:** v2.4.0

---

## Executive Summary

DEC-009 introduced `activation-context.yaml` to optimize mode activation. In practice:
1. **The file was rarely generated** - *handoff and *learning save didn't reliably trigger regeneration
2. **Fallback defeated the purpose** - When missing, modes fell back to reading handoff.md (1400+ lines)
3. **Added complexity** - Another file to maintain and debug

**Key Decision:** Deprecate `activation-context.yaml`. Instead, use a simpler 4-step activation:
1. Read `learning-index.yaml` (lightweight, ~30 lines)
2. Check beads tracker (`bd ready`)
3. Show pending tasks
4. Load full docs **ON-DEMAND** only when task is selected

---

## Table of Contents

1. [Problem Statement](#1-problem-statement)
2. [Solution Design](#2-solution-design)
3. [Implementation](#3-implementation)
4. [Affected Files](#4-affected-files)
5. [Migration](#5-migration)
6. [Testing](#6-testing)
7. [Deprecation Notes](#7-deprecation-notes)

---

## 1. Problem Statement

### DEC-009 Failure Analysis

DEC-009 promised 97% context reduction via `activation-context.yaml`. Reality:

| Expected | Actual |
|----------|--------|
| activation-context.yaml loaded first | File often missing or stale |
| ~50 lines loaded on activation | Fallback reads handoff.md (1400+ lines) |
| Auto-regenerated on *handoff/*learning save | Scripts existed but weren't reliably executed |
| Single file read | Multiple file reads on fallback |

**Root Causes:**

1. **Script execution unreliable** - Agents don't always execute PowerShell scripts
2. **Fallback too verbose** - Reading handoff.md defeats the optimization
3. **Complexity without benefit** - Another file to maintain that often doesn't exist

### User-Observed Behavior

Tasks app project activation:
```
Read(docs\handoff.md)           → 1417 lines
Read(.mlda\config.yaml)         → 90 lines
Read(.mlda\registry.yaml)       → 425 lines
```

**Total:** ~1932 lines loaded before any work begins, despite DEC-009 being "implemented".

### The Simpler Alternative

`learning-index.yaml` already exists and is auto-regenerated by `*learning save`. It contains:
- Topic summaries
- Session counts
- Key insights
- Primary DOC-IDs

This is sufficient for mode activation. Everything else can load ON-DEMAND.

---

## 2. Solution Design

### Simplified Activation Flow

```
┌─────────────────────────────────────────────────────────────────┐
│  STEP 1: Learning Index (~30 lines)                             │
│  - Read .mlda/learning-index.yaml                               │
│  - Know what topics exist, top insights                         │
│  - If missing: "MLDA not initialized" (proceed anyway)          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  STEP 2: Beads Check                                            │
│  - Run: bd ready --json                                         │
│  - Show pending tasks with priorities                           │
│  - If beads not initialized: skip (no error)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  STEP 3: Greeting & Ready State                                 │
│  - Greet as persona (Maya, Winston, Uma, Devon, Brian)          │
│  - Report: "Learning: {n} topics | Tasks: {m} ready"            │
│  - Show available commands (*help)                              │
│  - Await user instructions                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ (ON-DEMAND when task selected)
┌─────────────────────────────────────────────────────────────────┐
│  STEP 4: Deep Context (only when needed)                        │
│  - Identify topic from task DOC-IDs                             │
│  - Load: .mlda/topics/{topic}/learning.yaml                     │
│  - Load: Relevant sections of docs/handoff.md                   │
│  - Load: Relevant DOC-IDs from .mlda/registry.yaml              │
│  - Execute: *gather-context if comprehensive traversal needed   │
└─────────────────────────────────────────────────────────────────┘
```

### Why This Is Better

| Aspect | DEC-009 (activation-context.yaml) | DEC-JAN-26 (Simplified) |
|--------|-----------------------------------|-------------------------|
| Files to maintain | 4+ (context, schema, script, modes) | 1 (learning-index) |
| Auto-regeneration | Unreliable (script execution) | Reliable (*learning save) |
| Fallback behavior | Reads 1400+ lines anyway | N/A (no fallback needed) |
| Beads integration | None | Native |
| Complexity | High | Low |

### Context Budget

| Step | File | Lines | When |
|------|------|-------|------|
| 1 | learning-index.yaml | ~30 | Always |
| 2 | beads (bd ready) | ~10 | Always |
| 3 | Greeting | 0 | Always |
| 4a | topic/learning.yaml | ~50-100 | On task selection |
| 4b | handoff.md (relevant section) | ~50-100 | On task selection |
| 4c | registry.yaml (DOC-ID lookup) | ~20 | On DOC-ID reference |

**Activation context:** ~40 lines (vs DEC-009's promised 50-80, actual 1900+)
**Working context:** +150-200 lines ON-DEMAND (only when actually needed)

---

## 3. Implementation

### 3.1 Mode Activation Protocol

Replace all mode activation protocols with this unified version:

```markdown
## Activation Protocol (MANDATORY)

When this mode is invoked, execute these steps IN ORDER:

### Step 1: Load Learning Index
- [ ] Read `.mlda/learning-index.yaml`
- [ ] If missing: note "MLDA not initialized" and proceed
- [ ] Extract: topic count, total sessions, recent topics

### Step 2: Check Beads Tasks
- [ ] Run: `bd ready --json` (suppress errors if not initialized)
- [ ] Extract: ready task count, top 3 task titles
- [ ] If beads not available: skip silently

### Step 3: Greeting & Ready State
- [ ] Greet as [Persona Name], the [Role Title]
- [ ] Report status using format:
  ```
  Learning: {n} topics, {m} sessions
  Tasks: {ready_count} ready
  [List top 3 ready tasks if any]
  ```
- [ ] Show available commands (`*help`)
- [ ] Await user instructions

### Step 4: Deep Context (ON-DEMAND)
Load full context ONLY when user selects a task or requests specific information:

**On task selection:**
- [ ] Identify topic from task DOC-ID references
- [ ] Load topic learning: `.mlda/topics/{topic}/learning.yaml`
- [ ] Load relevant handoff section (current phase only)
- [ ] Apply learned co-activation patterns

**On DOC-ID reference:**
- [ ] Look up in registry for file path
- [ ] Load document and related docs

**On *gather-context:**
- [ ] Execute full MLDA traversal as defined in skill
```

### 3.2 Remove activation-context.yaml References

Delete from all mode files:
- References to `.mlda/activation-context.yaml`
- Fallback logic that reads handoff.md first
- Instructions to regenerate activation context

### 3.3 Update Fallback Behavior

**Old fallback (DEC-009):**
```
If activation-context.yaml missing:
1. Read docs/handoff.md (1400 lines)
2. Read .mlda/registry.yaml (425 lines)
3. Read .mlda/learning-index.yaml (30 lines)
```

**New behavior (DEC-JAN-26):**
```
If learning-index.yaml missing:
1. Note: "MLDA not initialized"
2. Proceed with activation (beads check, greeting)
3. Full MLDA features available after *init-project
```

No fallback reads large files. If MLDA isn't initialized, that's fine - modes still work.

### 3.4 Beads Integration

Add beads check to all modes:

```powershell
# In activation, run silently:
$beadsReady = bd ready --json 2>$null | ConvertFrom-Json

# Report if available:
if ($beadsReady) {
    Write-Output "Tasks: $($beadsReady.Count) ready"
    $beadsReady | Select-Object -First 3 | ForEach-Object {
        Write-Output "  - [$($_.priority)] $($_.title)"
    }
}
```

---

## 4. Affected Files

### Files to Modify

| File | Change |
|------|--------|
| `.claude/commands/modes/analyst.md` | New simplified activation protocol |
| `.claude/commands/modes/architect.md` | New simplified activation protocol |
| `.claude/commands/modes/dev.md` | New simplified activation protocol |
| `.claude/commands/modes/ux-expert.md` | New simplified activation protocol |
| `.claude/commands/modes/bmad-master.md` | New simplified activation protocol |
| `CLAUDE.md` (project) | Update Neocortex Protocol section |
| `~/.claude/CLAUDE.md` (global) | Update Neocortex Protocol section |

### Files to Deprecate (Not Delete)

| File | Status |
|------|--------|
| `.mlda/activation-context.yaml` | Deprecated - no longer generated or read |
| `.mlda/scripts/mlda-generate-activation-context.ps1` | Deprecated - keep for reference |
| `.mlda/schemas/activation-context.schema.yaml` | Deprecated - keep for reference |

### Documentation Updates

| File | Change |
|------|--------|
| `docs/NEOCORTEX.md` | Update activation section |
| `docs/USER-GUIDE.md` | Update mode activation instructions |
| `docs/architecture/neocortex-architecture.md` | Update context loading diagram |
| `docs/release-notes.md` | v2.3.0 release notes |
| `CHANGELOG.md` | v2.3.0 entry |

---

## 5. Migration

### For Existing Projects

1. **Update mode files** - Copy from Ways of Development
2. **No data migration needed** - learning-index.yaml already exists
3. **Optional cleanup** - Delete activation-context.yaml if present

### For New Projects

1. **Initialize** - `mlda-init-project.ps1` (unchanged)
2. **First learning save** - Generates learning-index.yaml automatically
3. **Beads** - Initialize separately with `bd init`

### Backward Compatibility

- Projects with activation-context.yaml: File ignored, no errors
- Projects without learning-index.yaml: "MLDA not initialized" message, proceed normally
- Projects without beads: Beads check skipped silently

---

## 6. Testing

### Test Cases

| Test | Expected Behavior |
|------|-------------------|
| Mode activation (MLDA initialized) | Reads learning-index only (~30 lines) |
| Mode activation (MLDA not initialized) | Notes "not initialized", proceeds |
| Mode activation (beads initialized) | Shows ready tasks |
| Mode activation (beads not initialized) | Skips beads check silently |
| Task selection | Loads topic learning + relevant handoff |
| DOC-ID reference | Loads specific document from registry |

### Success Criteria

| Metric | DEC-009 Target | DEC-009 Actual | DEC-JAN-26 Target |
|--------|----------------|----------------|-------------------|
| Activation context | ~50 lines | ~1900 lines | ~40 lines |
| File reads on activation | 1 | 3-4 | 1-2 |
| Fallback complexity | Medium | High | None |
| Beads integration | None | None | Native |

---

## 7. Deprecation Notes

### DEC-009 Status: DEPRECATED

DEC-009 is deprecated as of v2.3.0. Reasons:
1. Implementation didn't match design (fallback defeated purpose)
2. Script execution unreliable in agent context
3. Simpler solution achieves same goal with less complexity

### Files Deprecated

| File | Reason | Action |
|------|--------|--------|
| `activation-context.yaml` | No longer used | Keep for reference, do not generate |
| `mlda-generate-activation-context.ps1` | No longer needed | Keep for reference |
| `activation-context.schema.yaml` | No longer needed | Keep for reference |

### What's NOT Deprecated

- `learning-index.yaml` - Still the core of two-tier learning (DEC-007)
- `mlda-generate-index.ps1` - Still needed for learning index regeneration
- All other MLDA/Neocortex components - Unchanged

---

## 8. Agent Consolidation (v2.4.0)

### Problem: Duplicate Agent Definitions

During v2.3.0 deployment, agents loaded full context at activation despite DEC-JAN-26 instructions. Investigation revealed:

```
.claude/commands/
├── modes/           # Updated with DEC-JAN-26 protocol ✓
│   ├── analyst.md
│   ├── architect.md
│   ├── dev.md
│   └── ...
│
└── bmad-agents/     # NOT updated - still had old protocol ✗
    ├── analyst.md   # Loaded handoff.md, registry.yaml, config.yaml at startup
    ├── architect.md
    ├── dev.md
    └── ...
```

**Root Cause:** Two folders defining the same agents created a sync problem. Updates to `modes/` weren't mirrored to `bmad-agents/`.

### Solution: Single Source of Truth

**Decision:** Delete `bmad-agents/` folder entirely. Use `modes/` as the single source of truth.

| Before | After |
|--------|-------|
| `/bmad-agents:dev` + `/modes:dev` | `/modes:dev` only |
| 2 places to maintain | 1 place to maintain |
| Sync issues possible | No sync issues |

### Invocation Change

| Old Path | New Path |
|----------|----------|
| `/bmad-agents:analyst` | `/modes:analyst` |
| `/bmad-agents:architect` | `/modes:architect` |
| `/bmad-agents:dev` | `/modes:dev` |
| `/bmad-agents:ux-expert` | `/modes:ux-expert` |
| `/bmad-agents:bmad-master` | `/modes:bmad-master` |

### Migration

For existing projects:
1. Delete `.claude/commands/bmad-agents/` folder
2. Update any documentation referencing `/bmad-agents:*` paths
3. Use `/modes:*` for all mode invocations

### Why Not Redirects?

Considered keeping `bmad-agents/` with redirect stubs, but:
- Adds maintenance burden (even thin files need updating)
- Confuses users about which path to use
- Clean deletion is simpler and clearer

---

## References

| Document | Relationship |
|----------|--------------|
| DEC-009-activation-context-optimization.md | Superseded by this decision |
| DEC-007-two-tier-learning.md | Parent decision (learning-index) |
| DEC-008-auto-regenerate-learning-index.md | Related (auto-regeneration) |

---

*DOC-PROC-010 | Simplified Activation Protocol | v2.0 (Agent Consolidation)*
